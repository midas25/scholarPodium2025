<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>테스트 랭킹</title>
  <style>
    :root {
      font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111;
      background: #f5f5f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .card {
      background: #fff;
      width: min(720px, 100%);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.15);
      padding: 2.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.75rem, 3vw, 2.25rem);
    }

    .status {
      font-size: 0.9rem;
      color: #4b5563;
      margin-top: 0.5rem;
    }

    .status.error {
      color: #dc2626;
    }

    .status.success {
      color: #15803d;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      align-items: end;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    input {
      padding: 0.75rem 0.9rem;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 1rem;
    }

    input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }

    button[type="submit"] {
      padding: 0.85rem 1rem;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      background: #111827;
      color: #fff;
      cursor: pointer;
      transition: filter 160ms ease, transform 160ms ease;
    }

    button[type="submit"]:hover {
      filter: brightness(1.1);
    }

    button[type="submit"]:active {
      transform: translateY(1px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
    }

    thead {
      background: #111827;
      color: #fff;
    }

    th,
    td {
      text-align: left;
      padding: 0.9rem 1rem;
      font-size: 0.95rem;
    }

    tbody tr:nth-child(every) {
      background: #fff;
    }

    tbody tr:nth-child(odd) {
      background: #eef2ff;
    }

    .rank {
      font-weight: 700;
    }

    @media (max-width: 640px) {
      .card {
        padding: 1.5rem;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      th {
        display: none;
      }

      tr {
        margin-bottom: 1rem;
        border-radius: 12px;
        background: #fff;
      }

      td {
        display: flex;
        justify-content: space-between;
        padding: 0.6rem 0.9rem;
        border-bottom: 1px solid #e4e4e7;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #6b7280;
      }

      td:last-child {
        border-bottom: none;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <header>
      <h1>플레이어 점수 입력</h1>
      <p>테스트용으로 프론트에서만 동작합니다.</p>
      <p id="status-message" class="status">랭킹을 불러오는 중입니다…</p>
    </header>

    <form id="score-form">
      <label>
        플레이어 ID
        <input id="player-id" name="playerId" placeholder="예: knight_01" required>
      </label>

      <label>
        점수
        <input id="score" name="score" type="number" min="0" step="1" placeholder="예: 12345" required>
      </label>

      <button type="submit">등록</button>
    </form>

    <section>
      <h2>현재 랭킹</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>플레이어</th>
            <th>점수</th>
          </tr>
        </thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </section>
  </main>

  <script>
    const API_BASE_URL = "https://broad-bad-9cd25.rtioalb2250.workers.dev";
    const rankingBody = document.querySelector("#ranking-body");
    const scoreForm = document.querySelector("#score-form");
    const statusMessage = document.querySelector("#status-message");
    const players = [];

    const setStatus = (message, type = "") => {
      statusMessage.textContent = message;
      statusMessage.classList.remove("error", "success");
      if (type) {
        statusMessage.classList.add(type);
      }
    };

    const renderRows = () => {
      if (!players.length) {
        rankingBody.innerHTML = `
          <tr>
            <td colspan="3" style="text-align:center;">등록된 플레이어가 없습니다.</td>
          </tr>
        `;
        return;
      }

      players.sort((a, b) => b.score - a.score);
      rankingBody.innerHTML = players.map((player, index) => {
        return `
          <tr>
            <td class="rank" data-label="순위">${index + 1}</td>
            <td data-label="플레이어">${player.name ?? player.id}</td>
            <td data-label="점수">${player.score.toLocaleString()}</td>
          </tr>
        `;
      }).join("");
    };

    const loadPlayers = async () => {
      try {
        setStatus("랭킹을 불러오는 중입니다…");
        const response = await fetch(`${API_BASE_URL}/players`);
        if (!response.ok) {
          throw new Error(`서버 응답이 올바르지 않습니다. (${response.status})`);
        }
        const data = await response.json();
        players.splice(
          0,
          players.length,
          ...data.map((player) => ({
            id: player.id,
            name: player.name,
            score: Number(player.game1) || 0
          }))
        );
        renderRows();
        setStatus("랭킹이 최신 상태로 동기화되었습니다.", "success");
      } catch (error) {
        console.error("랭킹 불러오기 실패:", error);
        players.splice(0, players.length);
        renderRows();
        setStatus("랭킹을 불러오지 못했습니다. 잠시 후 다시 시도해 주세요.", "error");
      }
    };

    scoreForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const idInput = document.querySelector("#player-id");
      const scoreInput = document.querySelector("#score");
      const id = idInput.value.trim();
      const score = Number(scoreInput.value);

      if (!id) {
        idInput.focus();
        return;
      }

      if (!Number.isFinite(score) || score < 0) {
        scoreInput.focus();
        return;
      }

      try {
        setStatus("점수를 등록하는 중입니다…");
        const response = await fetch(`${API_BASE_URL}/players`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name: id, game1: score })
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || "등록 중 오류가 발생했습니다.");
        }

        scoreForm.reset();
        idInput.focus();
        setStatus("점수가 등록되었습니다. 랭킹을 새로고침합니다…", "success");
        await loadPlayers();
      } catch (error) {
        console.error("점수 등록 실패:", error);
        setStatus(`점수 등록에 실패했습니다: ${error.message}`, "error");
      }
    });

    loadPlayers();
  </script>
</body>
</html>
